<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Tracce GPX</title>
    
    <!-- Leaflet CSS per la mappa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        #menu {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); max-width: 250px;
        }
        .track-item { 
            border-bottom: 1px solid #eee; padding: 5px 0; font-size: 14px; 
        }
        button { cursor: pointer; margin-top: 5px; width: 100%; }
    </style>
</head>
<body>

    <div id="menu">
        <h3>Tracce Vicine</h3>
        <p id="status">Clicca sulla mappa per cercare tracce nel raggio di 500m</p>
        <div id="lista-tracce"></div>
    </div>

    <div id="map"></div>

    <!-- Librerie: Supabase e Leaflet -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://tuo-progetto.supabase.co';
        const SUPABASE_KEY = 'tua-chiave-anon-public';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. INIZIALIZZAZIONE MAPPA (Centrata sulla zona Grosseto/Maremma)
        const map = L.map('map').setView([42.75, 11.15], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let tracciaAttuale = null;

        // 3. FUNZIONE CLICK SULLA MAPPA
        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            document.getElementById('status').innerText = "Ricerca in corso...";
            
            // Chiamata alla funzione RPC creata precedentemente
            const { data, error } = await supabase.rpc('cerca_tracce_vicine', {
                click_lat: lat,
                click_lon: lng,
                raggio_metri: 500
            });

            if (error) {
                console.error(error);
                return;
            }

            mostraRisultati(data);
        });

        // 4. MOSTRA RISULTATI NEL MENU
        function mostraRisultati(tracce) {
            const lista = document.getElementById('lista-tracce');
            const status = document.getElementById('status');
            lista.innerHTML = "";

            if (tracce.length === 0) {
                status.innerText = "Nessuna traccia trovata in questo punto.";
                return;
            }

            status.innerText = `Trovate ${tracce.length} tracce:`;

            tracce.forEach(t => {
                const div = document.createElement('div');
                div.className = 'track-item';
                div.innerHTML = `
                    <strong>${t.nome_file}</strong><br>
                    Tipo: ${t.tipo_percorso} - Dist: ${t.distanza_metri.toFixed(0)}m<br>
                    <button onclick="caricaEVisualizza(${t.id})">Visualizza</button>
                    <button onclick="esportaGPX(${t.id}, '${t.nome_file}')">Scarica GPX</button>
                `;
                lista.appendChild(div);
            });
        }

        // 5. CARICA E DISEGNA LA TRACCIA
        async function caricaEVisualizza(id) {
            const { data, error } = await supabase
                .from('Tracce')
                .select('CoordLight')
                .eq('id', id)
                .single();

            if (tracciaAttuale) map.removeLayer(tracciaAttuale);

            const punti = JSON.parse(data.CoordLight);
            tracciaAttuale = L.polyline(punti, {color: 'red', weight: 4}).addTo(map);
            map.fitBounds(tracciaAttuale.getBounds());
        }

        // 6. ESPORTA IN FORMATO GPX STANDARD
        async function esportaGPX(id, nome) {
            const { data } = await supabase.from('Tracce').select('CoordLight').eq('id', id).single();
            const punti = JSON.parse(data.CoordLight);

            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="TracceGPX" xmlns="http://www.topografix.com/GPX/1/1">
  <trk>
    <name>${nome}</name>
    <trkseg>`;
            
            punti.forEach(p => {
                gpx += `\n      <trkpt lat="${p[0]}" lon="${p[1]}"></trkpt>`;
            });

            gpx += `\n    </trkseg>\n  </trk>\n</gpx>`;

            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${nome.replace(/\s+/g, '_')}.gpx`;
            a.click();
        }
    </script>
</body>
</html>