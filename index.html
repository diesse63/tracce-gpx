<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Archivio Tracce GPX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    /* ✅ Messaggio iniziale di caricamento */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    /* Aggiungi gli altri stili già presenti nel tuo progetto qui */
    /* ... (popup, legenda, filtro, ecc.) ... */
  </style>
</head>
<body>

  <!-- ✅ Messaggio di caricamento -->
  <div id="loading" class="loading-overlay">
    <div class="loading-message">Caricamento tracce in corso... attendere</div>
  </div>

  <!-- ✅ Mappa -->
  <div id="map"></div>

  <!-- ✅ Filtro, popup, ecc. -->
  <!-- Inserisci qui il tuo codice popup, filtro tracce, legenda, ecc. -->

  <!-- ✅ Libreria Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([43.0, 11.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const scriptURL = 'https://script.google.com/macros/s/AKfycbzNOYHF1LkaTV6xaYs3k2l0X3y3AvyE1lYCfr8-fv9SuoJW34_03e-l-lz0Ughb17H3Ng/exec';

    const getColorByTipo = tipo => tipo === 'Trekking' ? 'green' : tipo === 'MTB' ? 'red' : 'gray';
    let allTracce = [];

    fetch(scriptURL)
      .then(res => res.json())
      .then(data => {
        const allBounds = [];

        data.forEach(traccia => {
          if (!traccia.Coordinate) return;
          try {
            const coords = JSON.parse(traccia.Coordinate).map(c => Array.isArray(c) ? c : [c.lat, c.lon]);
            const tipo = traccia.TipoPercorso || "N/D";
            const colore = getColorByTipo(tipo);
            const polyline = L.polyline(coords, { color: colore, weight: 3 });

            polyline.addTo(map);
            allTracce.push({ ...traccia, coords, polyline });

            allBounds.push(...coords);
          } catch (e) {
            console.error("Errore parsing:", e);
          }
        });

        if (allBounds.length > 0) {
          map.fitBounds(allBounds);
        }

        // ✅ Nasconde il messaggio di caricamento
        document.getElementById("loading").style.display = "none";
      })
      .catch(err => {
        console.error("Errore nel caricamento:", err);
        document.getElementById("loading").textContent = "Errore nel caricamento delle tracce.";
      });
  </script>
</body>
</html>
