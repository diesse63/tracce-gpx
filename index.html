<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <!-- Meta tag fondamentali per App Mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <title>Archivio tracce GPX</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: #1a1a1a; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #f0f0f0; display: none; }
        
        /* Schermata Login */
        #auth-screen { position: fixed; inset: 0; background: #1a1a1a; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 340px; color: #333; text-align: center; }
        .login-box input { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .login-box button { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        #app-ui { display: none; }
        .top-controls { position: absolute; top: 10px; right: 55px; z-index: 1000; display: flex; gap: 6px; align-items: center; }
        
        .stats-badge { background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; padding: 0 8px; height: 32px; display: flex; align-items: center; font-size: 11px; font-weight: bold; color: #2c3e50; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .ctrl-btn { background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 0 10px; height: 36px; border-radius: 4px; font-size: 10px; font-weight: bold; cursor: pointer; }

        #btn-locate.following { background: #3498db; color: white; }

        /* Carousel Inferiore */
        #menu { position: absolute; bottom: 15px; left: 10px; right: 10px; z-index: 1000; background: white; border-radius: 12px; box-shadow: 0 -2px 25px rgba(0,0,0,0.4); display: none; flex-direction: column; border: 1px solid #ccc; }
        .menu-header { background: #2c3e50; color: white; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 11px 11px 0 0; }
        .menu-header h3 { margin: 0; font-size: 11px; text-transform: uppercase; flex-grow: 1; text-align: center; }
        .nav-btn { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0 10px; }

        #lista-tracce { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; background: #f8f9fa; border-radius: 0 0 11px 11px; }
        #lista-tracce::-webkit-scrollbar { display: none; }
        .track-card { flex: 0 0 100%; scroll-snap-align: start; box-sizing: border-box; padding: 15px; color: #333; }
        .track-date { color: #2c3e50; font-size: 15px; font-weight: bold; }
        .track-time { font-size: 11px; color: #7f8c8d; margin-left: 5px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; border-top: 1px solid #eee; padding-top: 8px; margin-bottom: 8px; }
        .stat-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #444; }
        .stat-icon { font-size: 14px; width: 18px; text-align: center; }

        .file-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; border-top: 1px dotted #ccc; padding-top: 8px; }
        .btn-action { border: none; padding: 6px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 10px; color: white; }

        /* Popup Altimetria */
        #alt-popup { position: fixed; top: 30%; left: 50%; transform: translateX(-50%); width: 95%; max-width: 450px; background: white; z-index: 4000; border-radius: 12px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; }
        #alt-header { background: #2c3e50; color: white; padding: 12px; cursor: move; border-radius: 11px 11px 0 0; display: flex; justify-content: space-between; align-items: center; }
        canvas { width: 100% !important; height: 200px !important; padding: 10px; box-sizing: border-box; }
        .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="login-box">
        <h2 style="margin-top:0">ARCHIVIO GPX</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="btn-login-action">ENTRA</button>
    </div>
</div>

<div id="app-ui">
    <div class="top-controls">
        <div id="stats-counter" class="stats-badge">MTB 0 - Trek 0</div>
        <button id="btn-locate" class="ctrl-btn" title="Posizione">üéØ</button>
        <label class="ctrl-btn">üì§ <input type="file" id="input-gpx" accept=".gpx" style="display:none"></label>
        <button class="logout-btn" id="btn-logout-action">LOGOUT</button>
    </div>

    <div id="menu">
        <div class="menu-header">
            <button class="nav-btn" id="btn-prev">&#10094;</button>
            <h3 id="count-label">0 TRACCE</h3>
            <button class="nav-btn" id="btn-next">&#10095;</button>
            <button class="close-btn" id="btn-close-menu">√ó</button>
        </div>
        <div id="lista-tracce"></div>
    </div>

    <div id="alt-popup">
        <div id="alt-header"><span id="alt-title" style="font-size:12px; font-weight:bold;">ALTIMETRIA</span><button class="close-btn" id="btn-close-alt">√ó</button></div>
        <canvas id="altChart"></canvas>
    </div>

    <div id="map"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Registrazione Service Worker per PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const supabaseClient = supabase.createClient('https://afdbrcywdooycvipzovs.supabase.co', 'sb_publishable_3wEeeRhDo6AHqZkk1mcE2w_Ykp3L-Nn');
    
    let map, tracceLayer, cache = {}, markerClick = null, highlightedId = null, chart = null, total = 0, tempImport = null;
    let userMarker = null, userCircle = null, isFollowing = false;
    const colMTB = '#e74c3c', colTRK = '#3498db', colACT = '#f39c12';

    // --- GPS ---
    function attivaGPS() {
        if (!navigator.geolocation) return;
        navigator.geolocation.watchPosition((pos) => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude, acc = pos.coords.accuracy;
            if (!userMarker) {
                userMarker = L.circleMarker([lat, lng], { radius: 9, color: '#fff', fillColor: '#3498db', fillOpacity: 1, weight: 3 }).addTo(map);
                userCircle = L.circle([lat, lng], { radius: acc, color: '#3498db', weight: 1, fillOpacity: 0.1 }).addTo(map);
                map.setView([lat, lng], 14);
            } else {
                userMarker.setLatLng([lat, lng]);
                userCircle.setLatLng([lat, lng]).setRadius(acc);
            }
            if (isFollowing) map.panTo([lat, lng]);
        }, null, { enableHighAccuracy: true });
    }

    document.getElementById('btn-locate').addEventListener('click', () => {
        isFollowing = !isFollowing;
        document.getElementById('btn-locate').classList.toggle('following', isFollowing);
        if (userMarker) map.panTo(userMarker.getLatLng());
    });

    // --- AUTH ---
    document.getElementById('btn-login-action').addEventListener('click', async () => {
        const user = document.getElementById('username').value, pass = document.getElementById('pass').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email: user + '@grifo.mtb', password: pass });
        if (error) alert("Accesso negato"); else location.reload();
    });

    document.getElementById('btn-logout-action').addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        location.reload();
    });

    async function checkSession() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            document.getElementById('map').style.display = 'block';
            initMap();
            attivaGPS();
            document.getElementById('btn-logout-action').innerText = "LOGOUT (" + user.email.split('@')[0].toUpperCase() + ")";
        }
    }

    function initMap() {
        if (map) return;
        map = L.map('map', { zoomControl: true, tap: false }).setView([42.85, 10.95], 13);
        map.zoomControl.setPosition('topright');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        tracceLayer = L.layerGroup().addTo(map);
        map.on('moveend', caricaArea);
        map.on('click', e => eseguiRicerca(e.latlng.lat, e.latlng.lng));
        caricaArea();
    }

    async function caricaArea() {
        const b = map.getBounds();
        const { data, error } = await supabaseClient.rpc('get_tracce_in_view', { min_lat: b.getSouth(), min_lon: b.getWest(), max_lat: b.getNorth(), max_lon: b.getEast() });
        if (error) return;
        let mtb = 0, trk = 0;
        data.forEach(t => {
            t.tipo_percorso === 'MTB' ? mtb++ : trk++;
            if (!cache[t.id]) {
                cache[t.id] = L.polyline(JSON.parse(t.geojson).coordinates.map(c => [c[1], c[0]]), { color: t.tipo_percorso === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.6, tipo: t.tipo_percorso }).addTo(tracceLayer)
                    .on('click', (e) => { L.DomEvent.stopPropagation(e); eseguiRicerca(e.latlng.lat, e.latlng.lng, t.id); });
            }
        });
        document.getElementById('stats-counter').innerText = `MTB ${mtb} - Trek ${trk}`;
    }

    async function eseguiRicerca(lat, lng, highlightId = null) {
        if (markerClick) map.removeLayer(markerClick);
        markerClick = L.circleMarker([lat, lng], { radius: 5, color: '#e74c3c' }).addTo(map);
        const { data, error } = await supabaseClient.rpc('cerca_tracce_vicine', { click_lat: lat, click_lon: lng, raggio_metri: 500 });
        if (error || !data.length) { chiudiMenu(); return; }
        
        total = data.length;
        const lista = document.getElementById('lista-tracce');
        lista.innerHTML = ""; document.getElementById('menu').style.display = 'flex';
        let targetIdx = 0;
        data.forEach((t, idx) => {
            if (highlightId && t.id == highlightId) targetIdx = idx;
            const d = new Date(t.data_unix * 1000);
            const card = document.createElement('div');
            card.className = 'track-card'; card.setAttribute('data-id', t.id);
            card.innerHTML = `<div class="track-header"><span class="track-date">üìÖ ${d.toLocaleDateString('it-IT')} <span class="track-time">ore ${d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})}</span></span></div><div class="stats-grid"><div class="stat-item"><span class="stat-icon">${t.tipo_percorso==='MTB'?'üöµ':'ü•æ'}</span> ${t.tipo_percorso}</div><div class="stat-item"><span class="stat-icon">üìè</span> ${t.lunghezza}km</div><div class="stat-item"><span class="stat-icon">‚õ∞Ô∏è</span> ${t.dislivello}m</div><div class="stat-item"><span class="stat-icon">üïí</span> ${t.durata}</div><div class="stat-item"><span class="stat-icon">üìç</span> ${t.distanza_metri.toFixed(0)}m</div></div><div class="file-row"><span class="file-name">üìÑ ${t.nome_file}</span><div class="btn-group"><button class="btn-action btn-alt-item" style="background:#3498db">üìà ALT</button><button class="btn-action btn-gpx-item" style="background:#27ae60">üíæ GPX</button></div></div>`;
            card.querySelector('.btn-alt-item').onclick = () => mostraAlt(t.id, t.nome_file);
            card.querySelector('.btn-gpx-item').onclick = () => scarica(t.id, t.nome_file);
            lista.appendChild(card);
        });
        setTimeout(() => { lista.scrollLeft = targetIdx * lista.offsetWidth; aggiornaVista(data[targetIdx].id, targetIdx + 1); }, 100);
    }

    function aggiornaVista(id, cur) {
        document.getElementById('count-label').innerText = `TRACCIA ${cur} DI ${total}`;
        if (highlightedId && cache[highlightedId]) cache[highlightedId].setStyle({ color: cache[highlightedId].options.tipo === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.6 });
        highlightedId = id;
        if (cache[id]) { cache[id].setStyle({ color: colACT, weight: 8, opacity: 1 }).bringToFront(); map.fitBounds(cache[id].getBounds(), { paddingBottomRight: [20, 180] }); }
    }

    const listCont = document.getElementById('lista-tracce');
    listCont.addEventListener('scroll', () => { clearTimeout(window.st); window.st = setTimeout(() => { const idx = Math.round(listCont.scrollLeft / listCont.offsetWidth); const card = listCont.children[idx]; if (card) aggiornaVista(card.getAttribute('data-id'), idx + 1); }, 150); });
    
    document.getElementById('btn-prev').onclick = () => listCont.scrollBy({ left: -listCont.offsetWidth, behavior: 'smooth' });
    document.getElementById('btn-next').onclick = () => listCont.scrollBy({ left: listCont.offsetWidth, behavior: 'smooth' });
    
    function chiudiMenu() { document.getElementById('menu').style.display='none'; if(markerClick) map.removeLayer(markerClick); if(highlightedId && cache[highlightedId]) cache[highlightedId].setStyle({ color: cache[highlightedId].options.tipo === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.6 }); highlightedId=null; }
    document.getElementById('btn-close-menu').onclick = chiudiMenu;

    async function scarica(id, nome) {
        const { data } = await supabaseClient.from('Tracce').select('CoordLight').eq('id', id).single();
        let pts = typeof data.CoordLight === 'string' ? JSON.parse(data.CoordLight) : data.CoordLight;
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="TracceGPX" xmlns="http://www.topografix.com/GPX/1/1"><metadata><name>${nome}</name></metadata><trk><name>${nome}</name><trkseg>${pts.map(p => `<trkpt lat="${p[0]}" lon="${p[1]}"></trkpt>`).join('')}</trkseg></trk></gpx>`;
        const b = new Blob([gpx], { type: 'application/gpx+xml' });
        const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `${nome}.gpx`; a.click();
    }

    async function mostraAlt(id, nome) {
        const { data } = await supabaseClient.from('Tracce').select('Altimetria').eq('id', id).single();
        const ad = typeof data.Altimetria === 'string' ? JSON.parse(data.Altimetria) : data.Altimetria;
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('altChart').getContext('2d'), { type: 'line', data: { labels: ad.map(p => p[0]), datasets: [{ label: 'Quota', data: ad.map(p => p[1]), borderColor: '#3498db', fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        document.getElementById('alt-title').innerText = "üìà " + nome.substring(0, 20); document.getElementById('alt-popup').style.display='flex';
    }

    // Drag altimetria
    const ap = document.getElementById("alt-popup"), ah = document.getElementById("alt-header");
    ah.onmousedown = (e) => { e.preventDefault(); let p3=e.clientX, p4=e.clientY; document.onmouseup=()=>document.onmousemove=null; document.onmousemove=(e)=>{ let p1=p3-e.clientX, p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; ap.style.top=(ap.offsetTop-p2)+"px"; ap.style.left=(ap.offsetLeft-p1)+"px"; ap.style.transform="none"; }; };

    checkSession();
</script>
</body>
</html>