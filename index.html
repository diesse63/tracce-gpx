<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Tracce GPX - diesse63</title>
    
    <!-- Leaflet CSS per la mappa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #menu {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3); width: 280px;
            max-height: 90vh; overflow-y: auto;
        }
        h3 { margin-top: 0; color: #2c3e50; font-size: 18px; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .track-item { 
            border-bottom: 1px solid #eee; padding: 10px 0; font-size: 13px; 
        }
        .track-item:last-child { border-bottom: none; }
        .track-item strong { color: #e67e22; display: block; margin-bottom: 3px; font-size: 14px; }
        .track-info { color: #34495e; line-height: 1.4; }
        button { 
            cursor: pointer; margin-top: 8px; width: 100%; 
            padding: 8px; border: none; border-radius: 4px;
            background: #3498db; color: white; font-weight: bold; transition: 0.2s;
        }
        button:hover { background: #2980b9; }
        button.download { background: #27ae60; margin-top: 5px; }
        button.download:hover { background: #219150; }
        #status { font-size: 12px; color: #7f8c8d; font-style: italic; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="menu">
        <h3>Esplora Tracce</h3>
        <p id="status">Clicca sulla mappa per cercare tracce nel raggio di 500m</p>
        <div id="lista-tracce"></div>
    </div>

    <div id="map"></div>

    <!-- Librerie: Supabase e Leaflet -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. CONFIGURAZIONE SUPABASE
        // Usiamo 'supabaseClient' per evitare conflitti con l'oggetto globale della libreria
        const SUPABASE_URL = 'https://afdbrcywdooycvipzovs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3wEeeRhDo6AHqZkk1mcE2w_Ykp3L-Nn';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. INIZIALIZZAZIONE MAPPA (Centrata sulla zona Maremma/Grosseto)
        const map = L.map('map').setView([42.85, 10.95], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let tracciaAttuale = null;
        let markerRicerca = null;

        // 3. FUNZIONE CLICK SULLA MAPPA
        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            
            // Gestione Marker di ricerca
            if (markerRicerca) map.removeLayer(markerRicerca);
            markerRicerca = L.circleMarker([lat, lng], { radius: 8, color: '#3498db', fillOpacity: 0.5 }).addTo(map);

            document.getElementById('status').innerText = "üîç Ricerca tracce vicine...";
            
            // Esegue la funzione RPC creata su Supabase
            const { data, error } = await supabaseClient.rpc('cerca_tracce_vicine', {
                click_lat: lat,
                click_lon: lng,
                raggio_metri: 500
            });

            if (error) {
                console.error("Errore Supabase:", error);
                document.getElementById('status').innerText = "‚ùå Errore nella ricerca.";
                return;
            }

            mostraRisultati(data);
        });

        // 4. MOSTRA RISULTATI NEL MENU
        function mostraRisultati(tracce) {
            const lista = document.getElementById('lista-tracce');
            const status = document.getElementById('status');
            lista.innerHTML = "";

            if (!tracce || tracce.length === 0) {
                status.innerText = "Nessuna traccia trovata in questo punto.";
                return;
            }

            status.innerText = `‚úÖ Trovate ${tracce.length} tracce:`;

            tracce.forEach(t => {
                const div = document.createElement('div');
                div.className = 'track-item';
                div.innerHTML = `
                    <strong>${t.nome_file}</strong>
                    <div class="track-info">
                        üö≤ ${t.tipo_percorso || 'MTB'} - üìè ${t.lunghezza || '?'} km<br>
                        üìç Distanza dal click: ${t.distanza_metri.toFixed(0)}m
                    </div>
                    <button onclick="caricaEVisualizza(${t.id})">üëÅÔ∏è Vedi su Mappa</button>
                    <button class="download" onclick="esportaGPX(${t.id}, '${t.nome_file}')">üíæ Scarica GPX</button>
                `;
                lista.appendChild(div);
            });
        }

        // 5. CARICA E DISEGNA LA LINEA SULLA MAPPA
        async function caricaEVisualizza(id) {
            const { data, error } = await supabaseClient
                .from('Tracce')
                .select('CoordLight')
                .eq('id', id)
                .single();

            if (error || !data) {
                alert("Errore nel caricamento della traccia");
                return;
            }

            if (tracciaAttuale) map.removeLayer(tracciaAttuale);

            try {
                const punti = JSON.parse(data.CoordLight);
                tracciaAttuale = L.polyline(punti, {
                    color: '#e67e22', 
                    weight: 5,
                    opacity: 0.8
                }).addTo(map);

                map.fitBounds(tracciaAttuale.getBounds(), { padding: [30, 30] });
            } catch (e) {
                console.error("Errore parsing coordinate:", e);
                alert("Dati coordinate non validi.");
            }
        }

        // 6. ESPORTAZIONE GPX (Standard Garmin)
        async function esportaGPX(id, nome) {
            const { data } = await supabaseClient.from('Tracce').select('CoordLight').eq('id', id).single();
            if (!data) return;
            
            try {
                const punti = JSON.parse(data.CoordLight);
                let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="TracceGPX-diesse63" xmlns="http://www.topografix.com/GPX/1/1">
  <trk>
    <name>${nome}</name>
    <trkseg>`;
                
                punti.forEach(p => {
                    gpx += `\n      <trkpt lat="${p[0]}" lon="${p[1]}"></trkpt>`;
                });

                gpx += `\n    </trkseg>\n  </trk>\n</gpx>`;

                const blob = new Blob([gpx], { type: 'application/gpx+xml' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${nome.replace(/\s+/g, '_')}.gpx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (e) {
                alert("Errore nella generazione del file GPX");
            }
        }
    </script>
</body>
</html>