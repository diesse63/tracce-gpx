<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archivio Riservato Tracce</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: #1a1a1a; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #f0f0f0; display: none; }
        
        #auth-screen { position: fixed; inset: 0; background: #1a1a1a; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 340px; color: #333; text-align: center; }
        .login-box input { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #app-ui { display: none; }
        .top-controls { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 8px; }
        .ctrl-btn { background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 0 12px; height: 36px; border-radius: 4px; font-size: 10px; font-weight: bold; cursor: pointer; }

        #menu {
            position: absolute; bottom: 15px; left: 10px; right: 10px; z-index: 1000;
            background: white; border-radius: 12px; box-shadow: 0 -2px 20px rgba(0,0,0,0.3); 
            display: none; flex-direction: column; border: 1px solid #ccc;
        }
        .menu-header { background: #2c3e50; color: white; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; }
        .menu-header h3 { margin: 0; font-size: 10px; text-transform: uppercase; flex-grow: 1; text-align: center; letter-spacing: 1px; }
        .nav-btn { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0 10px; }

        #lista-tracce { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; background: #f8f9fa; gap: 0; }
        #lista-tracce::-webkit-scrollbar { display: none; }
        .track-card { flex: 0 0 100%; scroll-snap-align: start; box-sizing: border-box; padding: 12px 18px; color: #333; }
        .track-date { color: #2c3e50; font-size: 14px; font-weight: bold; }
        .track-time { font-size: 10px; color: #7f8c8d; margin-left: 5px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; border-top: 1px solid #eee; padding-top: 6px; margin-bottom: 6px; }
        .stat-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #444; }
        .stat-icon { font-size: 13px; width: 18px; text-align: center; }

        .file-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; border-top: 1px dotted #ccc; padding-top: 6px; }
        .file-name { font-size: 10px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .btn-group { display: flex; gap: 4px; }
        .btn-action { border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 9px; color: white; }

        .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 320px; color: #333; }
        .modal-box textarea, .modal-box input { width: 100%; margin: 8px 0; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; font-family: inherit; }
        .modal-box textarea { height: 100px; resize: none; }

        #alt-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95%; max-width: 450px; background: white; z-index: 4000;
            border-radius: 12px; box-shadow: 0 10px 50px rgba(0,0,0,0.4); display: none; flex-direction: column; color: #333;
        }
        #alt-header { background: #2c3e50; color: white; padding: 10px; cursor: move; border-radius: 11px 11px 0 0; display: flex; justify-content: space-between; align-items: center; }
        canvas { width: 100% !important; height: 180px !important; padding: 10px; box-sizing: border-box; }
        .close-btn { background: none; border: none; color: white; font-size: 22px; cursor: pointer; line-height: 1; }
        .btn-save { background: #27ae60; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="login-box">
        <h2 style="margin:0 0 10px 0; font-size: 18px;">ACCESSO RISERVATO</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="btn-login-action">ENTRA</button>
    </div>
</div>

<div id="app-ui">
    <div class="top-controls">
        <label class="ctrl-btn">üì§ <input type="file" id="input-gpx" accept=".gpx" style="display:none"></label>
        <button class="logout-btn" id="btn-logout-action">LOGOUT</button>
    </div>

    <div id="menu">
        <div class="menu-header">
            <button class="nav-btn" id="btn-prev">&#10094;</button>
            <h3 id="count-label">0 TRACCE</h3>
            <button class="nav-btn" id="btn-next">&#10095;</button>
            <button class="close-btn" id="btn-close-menu">√ó</button>
        </div>
        <div id="lista-tracce"></div>
    </div>

    <div id="note-modal" class="custom-modal">
        <div class="modal-box">
            <h4 style="margin:0">MODIFICA NOTE</h4>
            <p id="note-file-title" style="font-size:10px; color:#666; margin: 5px 0;"></p>
            <textarea id="edit-note-input"></textarea>
            <button class="btn-save" id="btn-save-note">SALVA MODIFICHE</button>
            <button class="close-modal-btn" style="width:100%; background:none; border:none; color:#999; margin-top:10px; cursor:pointer; font-size:11px;">Annulla</button>
        </div>
    </div>

    <div id="import-modal" class="custom-modal">
        <div class="modal-box">
            <h4 style="margin:0">DETTAGLI PERCORSO</h4>
            <p id="nome-file-info" style="font-size:10px; color:#666; margin: 8px 0;"></p>
            <label style="font-size:11px;">Creatore:</label>
            <input type="text" id="creatore-input" value="Daniele">
            <textarea id="note-import-input" placeholder="Note iniziali..."></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button id="btn-save-mtb" style="background:#e74c3c; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">MTB</button>
                <button id="btn-save-trk" style="background:#3498db; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">TREKKING</button>
            </div>
            <button id="btn-cancel-import" style="width:100%; background:none; border:none; color:#999; margin-top:10px; cursor:pointer; font-size:11px;">Annulla</button>
        </div>
    </div>

    <div id="alt-popup">
        <div id="alt-header"><span id="alt-title" style="font-size:11px; font-weight:bold;">ALTIMETRIA</span><button class="close-btn" id="btn-close-alt">√ó</button></div>
        <canvas id="altChart"></canvas>
    </div>

    <div id="map"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const supabaseClient = supabase.createClient('https://afdbrcywdooycvipzovs.supabase.co', 'sb_publishable_3wEeeRhDo6AHqZkk1mcE2w_Ykp3L-Nn');
    
    let map, tracceLayer, cache = {}, markerClick = null, highlightedId = null, chart = null, total = 0, tempImport = null, idInModifica = null;
    const colMTB = '#e74c3c', colTRK = '#3498db', colACT = '#f39c12';

    // EVENTI
    document.getElementById('btn-login-action').addEventListener('click', login);
    document.getElementById('btn-logout-action').addEventListener('click', logout);
    document.getElementById('btn-prev').addEventListener('click', () => cambiaRecord(-1));
    document.getElementById('btn-next').addEventListener('click', () => cambiaRecord(1));
    document.getElementById('btn-close-menu').addEventListener('click', chiudiMenu);
    document.getElementById('btn-close-alt').addEventListener('click', () => document.getElementById('alt-popup').style.display='none');
    document.getElementById('btn-save-note').addEventListener('click', salvaNotaModificata);
    document.getElementById('btn-save-mtb').addEventListener('click', () => salvaTraccia('MTB'));
    document.getElementById('btn-save-trk').addEventListener('click', () => salvaTraccia('Trekking'));
    document.getElementById('btn-cancel-import').addEventListener('click', () => document.getElementById('import-modal').style.display='none');
    document.getElementById('input-gpx').addEventListener('change', avviaImport);
    document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => document.getElementById('note-modal').style.display = 'none'));

    async function login() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('pass').value;
        const email = user.includes('@') ? user : user + '@grifo.mtb';
        const { error } = await supabaseClient.auth.signInWithPassword({ email: email, password: pass });
        if (error) alert("Credenziali errate"); else checkSession();
    }
    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }
    async function checkSession() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            document.getElementById('map').style.display = 'block';
            initMap();
            document.getElementById('btn-logout-action').innerText = "LOGOUT (" + user.email.split('@')[0].toUpperCase() + ")";
        }
    }

    function initMap() {
        if (map) return;
        map = L.map('map', { zoomControl: false }).setView([42.85, 10.95], 13);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        tracceLayer = L.layerGroup().addTo(map);
        map.on('moveend', caricaArea);
        map.on('click', e => eseguiRicerca(e.latlng.lat, e.latlng.lng));
        caricaArea();
    }

    async function caricaArea() {
        const b = map.getBounds();
        const { data, error } = await supabaseClient.rpc('get_tracce_in_view', { min_lat: b.getSouth(), min_lon: b.getWest(), max_lat: b.getNorth(), max_lon: b.getEast() });
        if (error) return;
        data.forEach(t => {
            if (!cache[t.id]) {
                const poly = L.polyline(JSON.parse(t.geojson).coordinates.map(c => [c[1], c[0]]), { 
                    color: t.tipo_percorso === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.5, tipo: t.tipo_percorso 
                }).addTo(tracceLayer);
                cache[t.id] = poly;
                poly.on('click', (e) => { L.DomEvent.stopPropagation(e); eseguiRicerca(e.latlng.lat, e.latlng.lng); });
            }
        });
    }

    async function eseguiRicerca(lat, lng, highlightId = null) {
        if (markerClick) map.removeLayer(markerClick);
        markerClick = L.circleMarker([lat, lng], { radius: 5, color: '#e74c3c' }).addTo(map);
        const { data, error } = await supabaseClient.rpc('cerca_tracce_vicine', { click_lat: lat, click_lon: lng, raggio_metri: 500 });
        if (error || !data.length) { chiudiMenu(); return; }
        
        const ids = data.map(d => d.id);
        const { data: details } = await supabaseClient.from('Tracce').select('id, Note, Creatore').in('id', ids);
        const detailsMap = Object.fromEntries((details || []).map(d => [d.id, d]));
        
        total = data.length;
        const lista = document.getElementById('lista-tracce');
        lista.innerHTML = "";
        document.getElementById('menu').style.display = 'flex';
        
        let initialIndex = 0;
        data.forEach((t, idx) => {
            if (highlightId && t.id == highlightId) initialIndex = idx;
            const d = new Date(t.data_unix * 1000);
            const det = detailsMap[t.id] || { Note: "", Creatore: "Daniele" };
            const card = document.createElement('div');
            card.className = 'track-card'; card.setAttribute('data-id', t.id);
            card.innerHTML = `
                <div class="track-header">
                    <span class="track-date">üìÖ ${d.toLocaleDateString('it-IT')} 
                    <span class="track-time">ore ${d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})} (${det.Creatore})</span></span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-icon">${t.tipo_percorso==='MTB'?'üöµ':'ü•æ'}</span> ${t.tipo_percorso}</div>
                    <div class="stat-item"><span class="stat-icon">üìè</span> ${t.lunghezza}km</div>
                    <div class="stat-item"><span class="stat-icon">‚õ∞Ô∏è</span> ${t.dislivello}m</div>
                    <div class="stat-item"><span class="stat-icon">üïí</span> ${t.durata}</div>
                </div>
                <div class="file-row">
                    <span class="file-name">üìÑ ${t.nome_file}</span>
                    <div class="btn-group">
                        <button class="btn-action btn-note-item" style="background:${(det.Note||'').trim() ? '#e74c3c' : '#000'}">üìù NOTE</button>
                        <button class="btn-action btn-alt-item" style="background:#3498db">üìà ALT</button>
                        <button class="btn-action btn-gpx-item" style="background:#27ae60">üíæ GPX</button>
                    </div>
                </div>`;
            card.querySelector('.btn-note-item').addEventListener('click', () => apriEditorNote(t.id, t.nome_file, det.Note));
            card.querySelector('.btn-alt-item').addEventListener('click', () => mostraAlt(t.id, t.nome_file));
            card.querySelector('.btn-gpx-item').addEventListener('click', () => scarica(t.id, t.nome_file));
            lista.appendChild(card);
        });
        
        // Sposta lo scroll sulla traccia corretta
        setTimeout(() => {
            lista.scrollLeft = initialIndex * lista.offsetWidth;
            aggiornaVista(data[initialIndex].id, initialIndex + 1);
        }, 100);
    }

    async function salvaNotaModificata() {
        const nuovaNota = document.getElementById('edit-note-input').value;
        const { error } = await supabaseClient.from('Tracce').update({ Note: nuovaNota }).eq('id', idInModifica);
        if (error) alert("Errore salvataggio: " + error.message);
        else {
            document.getElementById('note-modal').style.display = 'none';
            if (markerClick) {
                const latlng = markerClick.getLatLng();
                eseguiRicerca(latlng.lat, latlng.lng, idInModifica);
            }
        }
    }

    function aggiornaVista(id, cur) {
        document.getElementById('count-label').innerText = `TRACCIA ${cur} DI ${total}`;
        if (highlightedId && cache[highlightedId]) cache[highlightedId].setStyle({ color: cache[highlightedId].options.tipo === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.5 });
        highlightedId = id;
        if (cache[id]) { 
            cache[id].setStyle({ color: colACT, weight: 8, opacity: 1 }).bringToFront(); 
            map.fitBounds(cache[id].getBounds(), { paddingBottomRight: [20, 180] }); 
        }
    }

    const listCont = document.getElementById('lista-tracce');
    listCont.addEventListener('scroll', () => {
        clearTimeout(window.st);
        window.st = setTimeout(() => {
            const idx = Math.round(listCont.scrollLeft / listCont.offsetWidth);
            const card = listCont.children[idx];
            if (card) aggiornaVista(card.getAttribute('data-id'), idx + 1);
        }, 150);
    });

    function cambiaRecord(dir) { listCont.scrollBy({ left: dir * listCont.offsetWidth, behavior: 'smooth' }); }
    function chiudiMenu() { document.getElementById('menu').style.display='none'; if(markerClick) map.removeLayer(markerClick); if(highlightedId && cache[highlightedId]) cache[highlightedId].setStyle({ color: cache[highlightedId].options.tipo === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.5 }); highlightedId=null; }

    function avviaImport(ev) {
        const file = ev.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const xml = new DOMParser().parseFromString(e.target.result, "text/xml"), pts = xml.querySelectorAll("trkpt");
            let orig = [], alts = [], dist = 0, gain = 0, start = null, end = null;
            pts.forEach((p, i) => {
                const la = parseFloat(p.getAttribute("lat")), lo = parseFloat(p.getAttribute("lon")), el = parseFloat(p.querySelector("ele")?.textContent || 0), ti = p.querySelector("time")?.textContent;
                orig.push([la, lo]);
                if (i > 0) {
                    const R=6371, dLa=(la-orig[i-1][0])*Math.PI/180, dLo=(lo-orig[i-1][1])*Math.PI/180, a=Math.sin(dLa/2)**2+Math.cos(orig[i-1][0]*Math.PI/180)*Math.cos(la*Math.PI/180)*Math.sin(dLo/2)**2;
                    dist += R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
                    let ePr = parseFloat(pts[i-1].querySelector("ele")?.textContent || 0); if (el > ePr) gain += (el - ePr);
                }
                alts.push([parseFloat(dist.toFixed(2)), Math.round(el)]);
                if (i === 0) start = ti; end = ti;
            });
            const dU = start ? Math.floor(new Date(start).getTime()/1000) : Math.floor(Date.now()/1000);
            const DP = (p,e) => { let d=0,idx=0; for(let i=1;i<p.length-1;i++){ let dist=Math.abs((p[p.length-1][1]-p[0][1])*p[i][0]-(p[p.length-1][0]-p[0][0])*p[i][1]+p[p.length-1][0]*p[0][1]-p[p.length-1][1]*p[0][0])/Math.sqrt((p[p.length-1][1]-p[0][1])**2+(p[p.length-1][0]-p[0][0])**2); if(dist>d){idx=i;d=dist}} return d>e?DP(p.slice(0,idx+1),e).slice(0,-1).concat(DP(p.slice(idx),e)):[p[0],p[p.length-1]] };
            let dur = "--:--"; if(start && end){ const di = new Date(end)-new Date(start); dur = `${Math.floor(di/3600000).toString().padStart(2,'0')}:${Math.floor((di%3600000)/60000).toString().padStart(2,'0')}`; }
            tempImport = { NomeFile: dU.toString(), Data: dU, Lunghezza: parseFloat(dist.toFixed(2)), Dislivello: Math.round(gain).toString(), Durata: dur, CoordLight: DP(orig, 0.00005), Altimetria: alts };
            document.getElementById('nome-file-info').innerText = "Traccia Unix: " + dU;
            document.getElementById('import-modal').style.display='flex';
        };
        reader.readAsText(file);
    }

    async function salvaTraccia(tipo) {
        tempImport.TipoPercorso = tipo; 
        tempImport.Note = document.getElementById('note-import-input').value;
        tempImport.Creatore = document.getElementById('creatore-input').value;
        
        // 1. Inserimento
        const { data, error } = await supabaseClient.from('Tracce').insert([tempImport]).select();
        
        if (error) {
            if (error.code === '23505') {
                document.getElementById('import-modal').style.display = 'none';
                alert("Questa traccia esiste gi√† nell'archivio!");
            } else alert("Errore: " + error.message);
        } else {
            // 2. Successo!
            const nuovaTraccia = data[0];
            document.getElementById('import-modal').style.display = 'none';
            
            // 3. Carica l'area geografica per far apparire la nuova linea sulla mappa
            await caricaArea();
            
            // 4. Seleziona automaticamente la nuova traccia
            const primaCoord = nuovaTraccia.CoordLight[0];
            eseguiRicerca(primaCoord[0], primaCoord[1], nuovaTraccia.id);
            
            alert("Importazione completata!");
        }
    }

    async function scarica(id, nome) {
        const { data } = await supabaseClient.from('Tracce').select('CoordLight').eq('id', id).single();
        let pts = typeof data.CoordLight === 'string' ? JSON.parse(data.CoordLight) : data.CoordLight;
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="TracceGPX" xmlns="http://www.topografix.com/GPX/1/1"><metadata><name>${nome}</name></metadata><trk><name>${nome}</name><trkseg>${pts.map(p => `\n<trkpt lat="${p[0]}" lon="${p[1]}"></trkpt>`).join('')}\n</trkseg></trk></gpx>`;
        const b = new Blob([gpx], { type: 'application/gpx+xml' });
        const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `${nome}.gpx`; a.click();
    }
    async function mostraAlt(id, nome) {
        const { data } = await supabaseClient.from('Tracce').select('Altimetria').eq('id', id).single();
        const ad = typeof data.Altimetria === 'string' ? JSON.parse(data.Altimetria) : data.Altimetria;
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('altChart').getContext('2d'), { type: 'line', data: { labels: ad.map(p => p[0]), datasets: [{ label: 'm', data: ad.map(p => p[1]), borderColor: '#3498db', fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        document.getElementById('alt-title').innerText = "üìà " + nome.substring(0, 20); document.getElementById('alt-popup').style.display='flex';
    }

    const ap = document.getElementById("alt-popup"), ah = document.getElementById("alt-header");
    ah.addEventListener('mousedown', (e) => {
        e.preventDefault(); let p3=e.clientX, p4=e.clientY;
        const drag = (e) => { let p1=p3-e.clientX, p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; ap.style.top=(ap.offsetTop-p2)+"px"; ap.style.left=(ap.offsetLeft-p1)+"px"; ap.style.transform="none"; };
        const stop = () => { document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stop); };
        document.addEventListener('mousemove', drag); document.addEventListener('mouseup', stop);
    });

    checkSession();
</script>
</body>
</html>