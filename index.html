<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <title>Archivio tracce GPX</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: #1a1a1a; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #f0f0f0; display: none; }
        
        /* Schermata Login */
        #auth-screen { position: fixed; inset: 0; background: #1a1a1a; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 340px; color: #333; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .login-box button { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* Interfaccia */
        #app-ui { display: none; }
        .top-controls { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        .stats-badge { background: white; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; padding: 5px 10px; font-size: 10px; font-weight: bold; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); white-space: nowrap; }
        .ctrl-btn { background: white; border: 1px solid rgba(0,0,0,0.1); border-radius: 50%; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 0 15px; height: 36px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        #btn-filter.active { background: #ff4757; color: white; }
        #btn-locate.following { background: #3498db; color: white; }

        /* Carousel Inferiore */
        #menu { position: absolute; bottom: 15px; left: 10px; right: 10px; z-index: 1000; background: white; border-radius: 12px; box-shadow: 0 -2px 25px rgba(0,0,0,0.4); display: none; flex-direction: column; border: 1px solid #ccc; }
        .menu-header { background: #2c3e50; color: white; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 11px 11px 0 0; }
        .menu-header h3 { margin: 0; font-size: 10px; text-transform: uppercase; flex-grow: 1; text-align: center; }
        .nav-btn { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0 10px; }

        #lista-tracce { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; background: #f8f9fa; border-radius: 0 0 11px 11px; }
        #lista-tracce::-webkit-scrollbar { display: none; }
        .track-card { flex: 0 0 100%; scroll-snap-align: start; box-sizing: border-box; padding: 15px; color: #333; }
        .track-date { color: #2c3e50; font-size: 14px; font-weight: bold; }
        .track-time { font-size: 10px; color: #7f8c8d; margin-left: 5px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; border-top: 1px solid #eee; padding-top: 6px; margin-bottom: 6px; }
        .stat-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #444; }
        .stat-icon { font-size: 13px; width: 18px; text-align: center; }

        .file-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; border-top: 1px dotted #ccc; padding-top: 6px; }
        .btn-action { border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 9px; color: white; }

        .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 320px; color: #333; }
        .modal-box textarea, .modal-box input, .modal-box select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; box-sizing: border-box; font-family: inherit; margin-top: 5px; }

        #alt-popup { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); width: 95%; max-width: 450px; background: white; z-index: 4000; border-radius: 12px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; }
        #alt-header { background: #2c3e50; color: white; padding: 10px; cursor: move; border-radius: 11px 11px 0 0; display: flex; justify-content: space-between; align-items: center; }
        canvas { width: 100% !important; height: 180px !important; padding: 10px; box-sizing: border-box; }
        .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="login-box">
        <h2 style="margin-top:0">ARCHIVIO GPX</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="btn-login-action">ENTRA</button>
    </div>
</div>

<div id="app-ui">
    <div class="top-controls">
        <button class="logout-btn" id="btn-logout-action">LOGOUT</button>
        <div id="stats-counter" class="stats-badge">MTB 0 - Trek 0</div>
        <button id="btn-locate" class="ctrl-btn" title="Posizione">üéØ</button>
        <button id="btn-filter" class="ctrl-btn" title="Filtra">üîç</button>
        <label class="ctrl-btn">üì§ <input type="file" id="input-gpx" accept=".gpx" style="display:none" onchange="avviaImport(event)"></label>
    </div>

    <div id="menu">
        <div class="menu-header">
            <button class="nav-btn" id="btn-prev">&#10094;</button>
            <h3 id="count-label">0 TRACCE</h3>
            <button class="nav-btn" id="btn-next">&#10095;</button>
            <button class="close-btn" id="btn-close-menu">√ó</button>
        </div>
        <div id="lista-tracce"></div>
    </div>

    <!-- MODAL FILTRI -->
    <div id="filter-modal" class="custom-modal">
        <div class="modal-box">
            <h4 style="margin:0">FILTRA ARCHIVIO</h4>
            <div class="filter-section">
                <label style="font-size:11px; font-weight:bold;">Da (Mese/Anno)</label>
                <div style="display:flex; gap:5px;"><select id="f-m-start"></select><select id="f-y-start" class="year-select"></select></div>
                <label style="font-size:11px; font-weight:bold; margin-top:8px; display:block;">A (Mese/Anno)</label>
                <div style="display:flex; gap:5px;"><select id="f-m-end"></select><select id="f-y-end" class="year-select"></select></div>
            </div>
            <div style="margin-top:10px;">
                <label style="font-size:11px; font-weight:bold;">Dislivello (m)</label>
                <div style="display:flex; gap:5px;"><input type="number" id="f-min-disl" value="0"><input type="number" id="f-max-disl" value="3000"></div>
            </div>
            <div style="margin-top:10px;">
                <label style="font-size:11px; font-weight:bold;">Lunghezza (km)</label>
                <div style="display:flex; gap:5px;"><input type="number" id="f-min-len" value="0"><input type="number" id="f-max-len" value="200"></div>
            </div>
            <button class="btn-action" style="background:#27ae60; width:100%; margin-top:15px; padding:10px;" id="btn-apply-filters">APPLICA FILTRI</button>
            <button id="btn-clear-filters" style="width:100%; background:#95a5a6; color:white; border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer; margin-top:8px;">ANNULLA</button>
        </div>
    </div>

    <div id="import-modal" class="custom-modal">
        <div class="modal-box">
            <h4 style="margin:0">DETTAGLI IMPORTAZIONE</h4>
            <p id="nome-file-info" style="font-size:10px; color:#666; margin: 8px 0;"></p>
            <label style="font-size:11px;">Creatore:</label>
            <input type="text" id="creatore-input">
            <textarea id="note-import-input" placeholder="Note..."></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button id="btn-save-mtb" style="background:#e74c3c; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">MTB</button>
                <button id="btn-save-trk" style="background:#3498db; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">TREKKING</button>
            </div>
        </div>
    </div>

    <div id="alt-popup">
        <div id="alt-header"><span id="alt-title" style="font-size:11px; font-weight:bold;">ALTIMETRIA</span><button class="close-btn" id="btn-close-alt">√ó</button></div>
        <canvas id="altChart"></canvas>
    </div>

    <div id="map"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    const supabaseClient = supabase.createClient('https://afdbrcywdooycvipzovs.supabase.co', 'sb_publishable_3wEeeRhDo6AHqZkk1mcE2w_Ykp3L-Nn');
    
    let map, tracceLayer, cache = {}, markerClick = null, highlightedId = null, chart = null, total = 0, tempImport = null;
    let userMarker = null, userCircle = null, isFollowing = false, isImporting = false;
    let currentUserName = "Daniele";
    let activeFilters = { start: null, end: null, minDisl: 0, maxDisl: 3000, minLen: 0, maxLen: 200, isActive: false };
    const colMTB = '#e74c3c', colTRK = '#3498db', colACT = '#f39c12';

    // --- GESTORE STATO AUTH (Soluzione al problema del Login/Logout) ---
    supabaseClient.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN') {
            const emailName = session.user.email.split('@')[0];
            currentUserName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            document.getElementById('map').style.display = 'block';
            document.getElementById('btn-logout-action').innerText = "LOGOUT (" + currentUserName.toUpperCase() + ")";
            
            const savedFilters = sessionStorage.getItem('gpx_filters');
            if (savedFilters) activeFilters = JSON.parse(savedFilters);

            setupDropdowns();
            initMap();
            attivaGPS();
        } else if (event === 'SIGNED_OUT') {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-ui').style.display = 'none';
            document.getElementById('map').style.display = 'none';
            if (map) { map.remove(); map = null; }
            cache = {};
        }
    });

    // --- LOGIN ---
    document.getElementById('btn-login-action').addEventListener('click', async () => {
        const user = document.getElementById('username').value.toLowerCase().trim();
        const pass = document.getElementById('pass').value;
        let email = user;
        if (!user.includes('@')) {
            if (user === 'rampi') email = 'rampi@grifo.mtb';
            else if (user === 'trek') email = 'trek@king.old';
            else email = user + '@grifo.mtb';
        }
        const { error } = await supabaseClient.auth.signInWithPassword({ email: email, password: pass });
        if (error) alert("Credenziali errate: " + error.message);
    });

    document.getElementById('btn-logout-action').addEventListener('click', async () => {
        sessionStorage.removeItem('gpx_filters');
        await supabaseClient.auth.signOut();
    });

    // --- MAPPA ---
    function initMap() {
        if (map) return;
        map = L.map('map', { zoomControl: false, tap: false }).setView([42.85, 10.95], 13);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        tracceLayer = L.layerGroup().addTo(map);
        map.on('moveend', () => { if (!isImporting) caricaArea(); });
        map.on('mousedown touchstart', () => { isImporting = false; });
        map.on('click', e => eseguiRicerca(e.latlng.lat, e.latlng.lng));
        caricaArea();
    }

    function attivaGPS() {
        if (!navigator.geolocation) return;
        navigator.geolocation.watchPosition((pos) => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude, acc = pos.coords.accuracy;
            if (!userMarker) {
                userMarker = L.circleMarker([lat, lng], { radius: 9, color: '#fff', fillColor: '#3498db', fillOpacity: 1, weight: 3 }).addTo(map);
                userCircle = L.circle([lat, lng], { radius: acc, color: '#3498db', weight: 1, fillOpacity: 0.1 }).addTo(map);
                map.setView([lat, lng], 14);
            } else {
                userMarker.setLatLng([lat, lng]); userCircle.setLatLng([lat, lng]).setRadius(acc);
            }
            if (isFollowing) map.panTo([lat, lng]);
        }, null, { enableHighAccuracy: true });
    }

    document.getElementById('btn-locate').addEventListener('click', () => {
        isFollowing = !isFollowing;
        document.getElementById('btn-locate').classList.toggle('following', isFollowing);
        if (userMarker) map.panTo(userMarker.getLatLng());
    });

    // --- FILTRI ---
    function setupDropdowns() {
        const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
        const mStart = document.getElementById('f-m-start'), mEnd = document.getElementById('f-m-end');
        mStart.innerHTML = '<option value="1">Gennaio</option>' + months.slice(1).map((m, i) => `<option value="${i+2}">${m}</option>`).join('');
        mEnd.innerHTML = months.slice(0, 11).map((m, i) => `<option value="${i+1}">${m}</option>`).join('') + '<option value="12" selected>Dicembre</option>';
        const yearSelects = document.querySelectorAll('.year-select');
        let yearOptions = '';
        for (let y = 2018; y <= 2035; y++) yearOptions += `<option value="${y}">${y}</option>`;
        yearSelects.forEach(s => s.innerHTML = yearOptions);
        if (activeFilters.isActive) {
            const sd = new Date(activeFilters.start * 1000), ed = new Date(activeFilters.end * 1000);
            document.getElementById('f-m-start').value = sd.getMonth() + 1;
            document.getElementById('f-y-start').value = sd.getFullYear();
            document.getElementById('f-m-end').value = ed.getMonth() + 1;
            document.getElementById('f-y-end').value = ed.getFullYear();
            document.getElementById('f-min-disl').value = activeFilters.minDisl;
            document.getElementById('f-max-disl').value = activeFilters.maxDisl;
            document.getElementById('f-min-len').value = activeFilters.minLen;
            document.getElementById('f-max-len').value = activeFilters.maxLen;
            document.getElementById('btn-filter').classList.add('active');
        } else {
            document.getElementById('f-y-start').value = "2018"; document.getElementById('f-y-end').value = "2035";
        }
    }

    function applicaFiltri() {
        const ms = parseInt(document.getElementById('f-m-start').value), ys = parseInt(document.getElementById('f-y-start').value);
        const me = parseInt(document.getElementById('f-m-end').value), ye = parseInt(document.getElementById('f-y-end').value);
        const startD = new Date(ys, ms - 1, 1), endD = new Date(ye, me, 0, 23, 59, 59);
        if (startD > endD) return alert("ERRORE: Data inizio > fine");
        const f = { start: Math.floor(startD.getTime()/1000), end: Math.floor(endD.getTime()/1000), minDisl: parseFloat(document.getElementById('f-min-disl').value), maxDisl: parseFloat(document.getElementById('f-max-disl').value), minLen: parseFloat(document.getElementById('f-min-len').value), maxLen: parseFloat(document.getElementById('f-max-len').value), isActive: true };
        sessionStorage.setItem('gpx_filters', JSON.stringify(f)); sessionStorage.setItem('show_filter_alert', 'true');
        location.reload();
    }
    document.getElementById('btn-apply-filters').addEventListener('click', applicaFiltri);
    document.getElementById('btn-clear-filters').addEventListener('click', () => { sessionStorage.removeItem('gpx_filters'); location.reload(); });
    document.getElementById('btn-filter').addEventListener('click', () => document.getElementById('filter-modal').style.display='flex');

    // --- LOGICA RICERCA ---
    async function caricaArea() {
        if (!map) return;
        const b = map.getBounds();
        const { data, error } = await supabaseClient.rpc('get_tracce_in_view', { 
            min_lat: b.getSouth(), min_lon: b.getWest(), max_lat: b.getNorth(), max_lon: b.getEast(),
            f_start: activeFilters.start, f_end: activeFilters.end,
            f_min_disl: activeFilters.minDisl, f_max_disl: activeFilters.maxDisl,
            f_min_len: activeFilters.minLen, f_max_len: activeFilters.maxLen
        });
        if (error) return;
        let mtb = 0, trk = 0;
        data.forEach(t => {
            t.tipo_percorso === 'MTB' ? mtb++ : trk++;
            if (!cache[t.id]) {
                cache[t.id] = L.polyline(JSON.parse(t.geojson).coordinates.map(c => [c[1], c[0]]), { color: t.tipo_percorso === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.6, tipo: t.tipo_percorso }).addTo(tracceLayer)
                    .on('click', (e) => { L.DomEvent.stopPropagation(e); eseguiRicerca(e.latlng.lat, e.latlng.lng, t.id); });
            }
        });
        document.getElementById('stats-counter').innerText = `MTB ${mtb} - Trek ${trk}`;
        if(sessionStorage.getItem('show_filter_alert') === 'true') {
            alert(`FILTRO APPLICATO!\nTracce totali: ${data.length}\nMTB: ${mtb} | Trekking: ${trk}`);
            sessionStorage.removeItem('show_filter_alert');
        }
    }

    async function eseguiRicerca(lat, lng, highlightId = null) {
        if (markerClick) map.removeLayer(markerClick);
        markerClick = L.circleMarker([lat, lng], { radius: 5, color: '#e74c3c' }).addTo(map);
        const { data, error } = await supabaseClient.rpc('cerca_tracce_vicine', { click_lat: lat, click_lon: lng, raggio_metri: 500 });
        if (error || !data.length) { if(!isImporting) chiudiMenu(); return; }

        let filtered = data.filter(t => {
            if (!activeFilters.isActive) return true;
            const d = parseInt(t.data_unix), disl = parseFloat(t.dislivello) || 0, len = parseFloat(t.lunghezza) || 0;
            return (!activeFilters.start || d >= activeFilters.start) && (!activeFilters.end || d <= activeFilters.end) && (disl >= activeFilters.minDisl && disl <= activeFilters.maxDisl) && (len >= activeFilters.minLen && len <= activeFilters.maxLen);
        });
        if (isImporting && highlightId) filtered = filtered.filter(t => t.id == highlightId);
        if (!filtered.length) { if(!isImporting) chiudiMenu(); return; }

        const ids = filtered.map(d => d.id);
        const { data: details } = await supabaseClient.from('Tracce').select('id, Note, Creatore').in('id', ids);
        const detailsMap = Object.fromEntries((details || []).map(d => [d.id, d]));
        
        total = filtered.length;
        const lista = document.getElementById('lista-tracce');
        lista.innerHTML = ""; document.getElementById('menu').style.display = 'flex';
        let targetIdx = 0;
        filtered.forEach((t, idx) => {
            if (highlightId && t.id == highlightId) targetIdx = idx;
            const d = new Date(t.data_unix * 1000), det = detailsMap[t.id] || { Note: "", Creatore: "Daniele" };
            const card = document.createElement('div');
            card.className = 'track-card'; card.setAttribute('data-id', t.id);
            card.innerHTML = `<div class="track-header"><span class="track-date">üìÖ ${d.toLocaleDateString('it-IT')} <span class="track-time">ore ${d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})} (${det.Creatore})</span></span></div><div class="stats-grid"><div class="stat-item"><span class="stat-icon">${t.tipo_percorso==='MTB'?'üöµ':'ü•æ'}</span> ${t.tipo_percorso}</div><div class="stat-item"><span class="stat-icon">üìè</span> ${t.lunghezza}km</div><div class="stat-item"><span class="stat-icon">‚õ∞Ô∏è</span> ${t.dislivello}m</div><div class="stat-item"><span class="stat-icon">üïí</span> ${t.durata}</div><div class="stat-item"><span class="stat-icon">üìç</span> ${t.distanza_metri.toFixed(0)}m</div></div><div class="file-row"><span class="file-name" style="font-size:9px; color:#999;">üìÑ ${t.nome_file}</span><div class="btn-group"><button class="btn-action btn-alt-item" style="background:#3498db">üìà ALT</button><button class="btn-action btn-gpx-item" style="background:#27ae60">üíæ GPX</button></div></div>`;
            card.querySelector('.btn-alt-item').onclick = () => mostraAlt(t.id, t.nome_file);
            card.querySelector('.btn-gpx-item').onclick = () => scarica(t.id, t.nome_file);
            lista.appendChild(card);
        });
        setTimeout(() => { lista.scrollLeft = targetIdx * lista.offsetWidth; aggiornaVista(filtered[targetIdx].id, targetIdx + 1); }, 200);
    }

    function aggiornaVista(id, cur) {
        document.getElementById('count-label').innerText = `TRACCIA ${cur} DI ${total}`;
        if (highlightedId && cache[highlightedId]) cache[highlightedId].setStyle({ color: cache[highlightedId].options.tipo === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.6 });
        highlightedId = id;
        if (cache[id]) { cache[id].setStyle({ color: colACT, weight: 8, opacity: 1 }).bringToFront(); map.fitBounds(cache[id].getBounds(), { paddingBottomRight: [20, 180] }); }
    }

    const listCont = document.getElementById('lista-tracce');
    listCont.addEventListener('scroll', () => { clearTimeout(window.st); window.st = setTimeout(() => { const idx = Math.round(listCont.scrollLeft / listCont.offsetWidth); const card = listCont.children[idx]; if (card) aggiornaVista(card.getAttribute('data-id'), idx + 1); }, 150); });
    
    function chiudiMenu() { document.getElementById('menu').style.display='none'; if(markerClick) map.removeLayer(markerClick); if(highlightedId && cache[highlightedId]) { const t = cache[highlightedId]; t.setStyle({ color: t.options.tipo === 'MTB' ? colMTB : colTRK, weight: 3, opacity: 0.6 }); } highlightedId=null; isImporting = false; }
    document.getElementById('btn-close-menu').onclick = chiudiMenu;

    async function scarica(id, nome) {
        const { data } = await supabaseClient.from('Tracce').select('CoordLight').eq('id', id).single();
        let pts = typeof data.CoordLight === 'string' ? JSON.parse(data.CoordLight) : data.CoordLight;
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="TracceGPX" xmlns="http://www.topografix.com/GPX/1/1"><metadata><name>${nome}</name></metadata><trk><name>${nome}</name><trkseg>${pts.map(p => `<trkpt lat="${p[0]}" lon="${p[1]}"></trkpt>`).join('')}</trkseg></trk></gpx>`;
        const b = new Blob([gpx], { type: 'application/gpx+xml' });
        const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `${nome}.gpx`; a.click();
    }

    async function mostraAlt(id, nome) {
        const { data } = await supabaseClient.from('Tracce').select('Altimetria').eq('id', id).single();
        const ad = typeof data.Altimetria === 'string' ? JSON.parse(data.Altimetria) : data.Altimetria;
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('altChart').getContext('2d'), { type: 'line', data: { labels: ad.map(p => p[0]), datasets: [{ label: 'm', data: ad.map(p => p[1]), borderColor: '#3498db', fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        document.getElementById('alt-title').innerText = "üìà " + nome.substring(0, 20); document.getElementById('alt-popup').style.display='flex';
    }

    async function salvaTraccia(tipo) {
        tempImport.TipoPercorso = tipo; tempImport.Note = document.getElementById('note-import-input').value; tempImport.Creatore = document.getElementById('creatore-input').value;
        const { data, error } = await supabaseClient.from('Tracce').insert([tempImport]).select();
        if (error) { alert("Errore: " + error.message); return; }
        isImporting = true; document.getElementById('import-modal').style.display='none';
        tracceLayer.clearLayers(); cache = {};
        setTimeout(async () => { await caricaArea(); eseguiRicerca(data[0].CoordLight[0][0], data[0].CoordLight[0][1], data[0].id); }, 800);
    }

    function avviaImport(ev) {
        const file = ev.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const xml = new DOMParser().parseFromString(e.target.result, "text/xml"), pts = xml.querySelectorAll("trkpt");
            let orig = [], alts = [], dist = 0, gain = 0, start = null, end = null;
            pts.forEach((p, i) => {
                const la = parseFloat(p.getAttribute("lat")), lo = parseFloat(p.getAttribute("lon")), el = parseFloat(p.querySelector("ele")?.textContent || 0), ti = p.querySelector("time")?.textContent;
                orig.push([la, lo]);
                if (i > 0) {
                    const R=6371, dLa=(la-orig[i-1][0])*Math.PI/180, dLo=(lo-orig[i-1][1])*Math.PI/180, a=Math.sin(dLa/2)**2+Math.cos(orig[i-1][0]*Math.PI/180)*Math.cos(la*Math.PI/180)*Math.sin(dLo/2)**2;
                    dist += R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
                    let ePr = parseFloat(pts[i-1].querySelector("ele")?.textContent || 0); if (el > ePr) gain += (el - ePr);
                }
                alts.push([parseFloat(dist.toFixed(2)), Math.round(el)]); if (i === 0) start = ti; end = ti;
            });
            const dU = start ? Math.floor(new Date(start).getTime()/1000) : Math.floor(Date.now()/1000);
            const DP = (p,e) => { let d=0,idx=0; for(let i=1;i<p.length-1;i++){ let dist=Math.abs((p[p.length-1][1]-p[0][1])*p[i][0]-(p[p.length-1][0]-p[0][0])*p[i][1]+p[p.length-1][0]*p[0][1]-p[p.length-1][1]*p[0][0])/Math.sqrt((p[p.length-1][1]-p[0][1])**2+(p[p.length-1][0]-p[0][0])**2); if(dist>d){idx=i;d=dist}} return d>e?DP(p.slice(0,idx+1),e).slice(0,-1).concat(DP(p.slice(idx),e)):[p[0],p[p.length-1]] };
            tempImport = { NomeFile: dU.toString(), Data: dU, Lunghezza: parseFloat(dist.toFixed(2)), Dislivello: Math.round(gain).toString(), Durata: (start && end) ? `${Math.floor((new Date(end)-new Date(start))/3600000).toString().padStart(2,'0')}:${Math.floor(((new Date(end)-new Date(start))%3600000)/60000).toString().padStart(2,'0')}` : "--:--", CoordLight: DP(orig, 0.00005), Altimetria: alts };
            document.getElementById('nome-file-info').innerText = "Unix ID: " + dU; document.getElementById('creatore-input').value = currentUserName; document.getElementById('import-modal').style.display='flex';
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>