<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Dinamica Tracce - diesse63</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; }
        #menu {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3); width: 280px;
            max-height: 90vh; overflow-y: auto;
        }
        h3 { margin: 0 0 10px 0; font-size: 18px; border-bottom: 2px solid #3498db; }
        .track-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 13px; cursor: pointer; }
        .track-item:hover { background: #f9f9f9; }
        .track-item strong { color: #2980b9; display: block; }
        button { 
            cursor: pointer; margin-top: 5px; width: 100%; padding: 5px;
            background: #27ae60; color: white; border: none; border-radius: 4px;
        }
        #status { font-size: 11px; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="menu">
    <h3>Tracce in questa zona</h3>
    <p id="status">Sposta la mappa per caricare le tracce</p>
    <div id="lista-tracce"></div>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const SUPABASE_URL = 'https://afdbrcywdooycvipzovs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_3wEeeRhDo6AHqZkk1mcE2w_Ykp3L-Nn';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const map = L.map('map').setView([42.85, 10.95], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let layerGroup = L.layerGroup().addTo(map); // Contiene tutte le tracce visibili
    let tracciaSelezionata = null; // La traccia evidenziata
    let idsCaricati = new Set(); // Per non duplicare le tracce

    // 1. CARICAMENTO TRACCE NELL'AREA VISIBILE
    async function caricaTracceInVista() {
        const bounds = map.getBounds();
        document.getElementById('status').innerText = "ðŸ”„ Aggiornamento tracce...";

        const { data, error } = await supabaseClient.rpc('get_tracce_in_view', {
            min_lat: bounds.getSouth(),
            min_lon: bounds.getWest(),
            max_lat: bounds.getNorth(),
            max_lon: bounds.getEast()
        });

        if (error) {
            console.error(error);
            return;
        }

        const lista = document.getElementById('lista-tracce');
        lista.innerHTML = "";
        
        data.forEach(t => {
            // Aggiungi alla lista laterale
            const div = document.createElement('div');
            div.className = 'track-item';
            div.innerHTML = `<strong>${t.nome_file}</strong> ${t.tipo_percorso} - ${t.lunghezza}km
                             <button onclick="evidenziaTraccia(${t.id})">ðŸ’¾ Scarica GPX</button>`;
            div.onclick = () => evidenziaTraccia(t.id);
            lista.appendChild(div);

            // Se la traccia non Ã¨ ancora sulla mappa, disegnala (leggera)
            if (!idsCaricati.has(t.id)) {
                const punti = JSON.parse(t.coord_light);
                const poly = L.polyline(punti, {
                    color: '#95a5a6', 
                    weight: 2, 
                    opacity: 0.5,
                    id: t.id // custom id
                }).addTo(layerGroup);
                
                poly.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    evidenziaTraccia(t.id);
                });
                
                idsCaricati.add(t.id);
            }
        });

        document.getElementById('status').innerText = `Visualizzando ${data.length} tracce`;
    }

    // 2. EVIDENZIA TRACCIA SELEZIONATA
    function evidenziaTraccia(id) {
        layerGroup.eachLayer(layer => {
            if (layer.options.id === id) {
                if (tracciaSelezionata) {
                    tracciaSelezionata.setStyle({ color: '#95a5a6', weight: 2, opacity: 0.5 });
                }
                layer.setStyle({ color: '#e67e22', weight: 6, opacity: 1 });
                layer.bringToFront();
                tracciaSelezionata = layer;
                map.fitBounds(layer.getBounds(), {padding: [30,30]});
            }
        });
    }

    // 3. RICERCA PUNTUALE AL CLICK (500m)
    map.on('click', async (e) => {
        const { lat, lng } = e.latlng;
        const { data } = await supabaseClient.rpc('cerca_tracce_vicine', {
            click_lat: lat, click_lon: lng, raggio_metri: 500
        });

        if (data && data.length > 0) {
            evidenziaTraccia(data[0].id); // Evidenzia la piÃ¹ vicina
            alert("Traccia trovata: " + data[0].nome_file);
        }
    });

    // EVENTI MAPPA
    map.on('moveend', caricaTracceInVista); // Ricarica quando sposti o zoomi
    caricaTracceInVista(); // Caricamento iniziale

</script>
</body>
</html>